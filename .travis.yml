language: java
cache:
  directories:
    - $HOME/.m2

# do not build on tagged commits to avoid infinite loops
if: tag is blank

#services:
#  - docker

#env:
#  global:
#    - secure: "encrypted DOCKER_USERNAME=user"
#    - secure: "encrypted DOCKER_PASSWORD=pass"
      
stages:
  - test
  - name: deploy_edge
    if: type = push && tag is blank

script:
  - mvn verify -B -P integration-test

matrix:
  include:
  # tests
  - jdk: openjdk8
    stage: test
  - jdk: oraclejdk9
    before_install:
        # The OpenJDK9's CA bundle is outdated, so we're using the system's ones.
        - rm "${JAVA_HOME}/lib/security/cacerts"
        - ln -s /etc/ssl/certs/java/cacerts "${JAVA_HOME}/lib/security/cacerts"
  - jdk: openjdk11
  - jdk: openjdk12
  - jdk: openjdk13
  
  # deploy jobs
  - name: "Deploy Edge Release"
    stage: deploy_edge
    jdk: openjdk8
    before_script:
      - export PROJECT_MAVEN_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
      - export TRAVIS_TAG=${TRAVIS_TAG:-$PROJECT_MAVEN_VERSION+$(date +'%Y%m%d%H%M%S')}
      - echo $TRAVIS_TAG
    script: skip
      #- docker build -f install/docker/Dockerfile -t airsonic/airsonic:latest -t airsonic/airsonic:edge/$TRAVIS_TAG .
    before_deploy:
      # Set up git user name and tag this commit
      - git config --local user.name "Airsonic Travis CI"
      - git config --local user.email "builds@travis-ci.org"
      - git tag "$TRAVIS_TAG" -a -m "Generated tag $TRAVIS_TAG from Travis CI for build $TRAVIS_BUILD_NUMBER"
    deploy:
    - provider: releases
      api_key:
        secure: "I0aBwJhFlCjXmsVFffUMbR38wHp+HrsTBkYKePxWn5+prYgq+9dSz0IjWpHEszUdnCDQcHEJR4nFS2YLEBdEzC4sqkWZVpJEnSVF/izEbxjxb1fNdLeCqZAPkuqw5/pta9JKwdwFMvBLKkV+lBaXscr/sLipAtOIESs+EV1zP5GU0636s4IWA85yfrhKEgE2cjQqtgpbcIZXJWbZN+MtmAhSgeKvUzYGTjOFmF/xfO3ksBAAUd3j0bmsAgA/9+I5XCsR/IRW/PLLdi2ocwsHY+VqdrH4p5kHN3EV2MrjtvhbrRYRFdRoYcux5EXupdTOIMz03GW4wbPJm90hKa2BbaWkzHF9hv6X5boPFrOP+7XqW01X7FVp9dGringEv8CPd+iNPqJLrISDjztnWVuRxpcoJbKEaObYR3DXNyQJ5nbGlrp8vmqRPC2nIJT6UqgE2Bqcap4a1NBVXVQ/zjCCJbDv44QGYWGCL0WIbxOvsWKWvd1otqHi07x8nOAhivoBI44q7UGIoGg0BTs8+EXbbpoAu4cNgLteipByEdtoXnYA7P+L3QLR7kBY5Qyc0bwI2UyE9JlxJMb/90701DMCcKuzvW14aEsVeu00j53UEUCV+i2lKMBZf67VIFQuUvgtUhzzJcvlMaElqh8OrPImRhUkMV9HMY2+qyrHc5CucDg="
      file: airsonic-main/target/airsonic.war
      skip_cleanup: true
      prerelease: true
      name: "Edge Release $TRAVIS_TAG"
    #- provider: script
    #  script: bash install/docker/dockerhub_push.sh
