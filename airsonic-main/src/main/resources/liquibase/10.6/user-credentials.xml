<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet id="add-user-credentials" author="anon">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="user_credentials"/>
            </not>
        </preConditions>
        <createTable tableName="user_credentials">
            <column name="username" type="${varchar_type}">
                <constraints nullable="false" foreignKeyName="uc_u_fk" referencedTableName="user" referencedColumnNames="username" deleteCascade="true" />
            </column>
            <column name="location_username" type="${varchar_type}">
                <constraints nullable="false" />
            </column>
            <column name="credential" type="${varchar_type}">
                <constraints nullable="false" />
            </column>
            <column name="type" type="${varchar_type}">
                <constraints nullable="false" />
            </column>
            <column name="location" type="${varchar_type}">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime" defaultValueComputed="current_timestamp">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" defaultValueComputed="current_timestamp">
                <constraints nullable="false" />
            </column>
            <column name="expiration" type="datetime" />
        </createTable>
        <sql>insert into user_credentials (username, location_username, credential, type, location)
             select u.username, u.username, u.password, 'legacy', 'airsonic'
             from user u
        </sql>
        <sql>insert into user_credentials (username, location_username, credential, type, location)
             select u.username, u.last_fm_username, u.last_fm_password, 'legacy', 'last.fm'
             from user_settings u
             where u.last_fm_username is not null and u.last_fm_password is not null
        </sql>
        <sql>insert into user_credentials (username, location_username, credential, type, location)
             select u.username, 'listenbrainz', u.listenbrainz_token, 'legacy', 'listenbrainz'
             from user_settings u
             where u.listenbrainz_token is not null
        </sql>
        <rollback>
            <dropTable tableName="user_credentials"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
